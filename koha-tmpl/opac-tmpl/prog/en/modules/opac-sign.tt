<!DOCTYPE html>
<html>
<head>
<title>[% IF ( sign )  %][% sign.name %] - Koha[% ELSE %]Koha digital signs[% END %]</title>
<meta name="generator" content="Koha [% Version %]" /> <!-- leave this for stats -->
<link rel="shortcut icon" href="[% IF ( OpacFavicon ) %][% OpacFavicon %][% ELSE %][% themelang %]/includes/favicon.ico[% END %]" type="image/x-icon" />
<meta name="viewport" content="width=device-width, initial-scale=1">
[%- IF ( sign.webapp ) %]<meta name="apple-mobile-web-app-capable" content="yes" />[% END -%]
[%# FIXME Use the JQM files from JQM in early stages of development, to be replaced with a local version later %]
[%# <script type="text/javascript" src="[% themelang % ]/lib/jquery/jquery.js"></script> %]
[%- IF ( OPACDigitalSignsCSS != '' ) -%]
  <style type="text/css">
  [% OPACDigitalSignsCSS %]
  </style>
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile.structure-1.2.0.min.css" />
[%- ELSE -%]
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />
[%- END -%]
<script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
[% IF ( sign ) %]
[%#
We only need this if we are displaying signs, not for the front page.
See http://jquerymobile.com/demos/1.2.0/docs/api/globalconfig.html for info about the order in which things are loaded.
%]
<script>

var ShowRecordsIntervalID;
var WaitForIdleTimeoutID;
var IsAnIdlePageChange = 0;
var WaitBeforeIdle     = 5 * 1000;
var WaitBetweenRecords = 5 * 1000;

$(document).bind("mobileinit", function(){

  // Catch the pagebeforechange event
  $(document).on( 'pagebeforechange',function(event, ui){
    if ( IsAnIdlePageChange == 0 ) {
      // This was initiated by a user, so reset all timeouts/intervals
      window.clearTimeout( WaitForIdleTimeoutID );
      window.clearInterval( ShowRecordsIntervalID );
      // Start counting so we know when we are idle again
      WaitForIdleTimeoutID = WaitForIdle();
    } else  {
      // This is the result of ShowRecords() turning pages automatically
      // window.clearTimeout( WaitForIdleTimeoutID );
    }
  });

  WaitForIdleTimeoutID = WaitForIdle();

});

function WaitForIdle() {

  // Wait a set amount of time before starting automatic page turning
  var IntID = window.setTimeout(function () {
    ShowRecordsIntervalID = ShowRecords();
  }, WaitBeforeIdle );

  return IntID;

}

function ShowRecords() {

  // Turn over pages in an infinite loop
  var number_of_records = $('.record').length;
  var t = 0;
  if ( number_of_records > 0 ) {
    var IntID = window.setInterval(function () {
      IsAnIdlePageChange = 1;
      var page = '#' + $('.record').slice(t).attr('id');
      $.mobile.changePage( page );
      IsAnIdlePageChange = 0;
      t = t + 1;
      // Go back to zero if we reached the max number of records, so we can loop infinitely
      if ( t == number_of_records ) {
        t = 0;
      }
    }, WaitBetweenRecords );
  }

  return IntID;

}

</script>
[% END %]
<script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
</head>
<body>
[%- IF ( enabled == 0 )  -%]
  <p>Digital signs are not enabled!</p>
[%- ELSE -%]

  [%# Display a sign, all its streams and all records  %]
  [%- IF ( sign )  -%]

    [%- IF ( streams.0 )  -%]

      [%# Iterate through the streams, creating one front page for each %]
      [%- FOREACH s IN streams -%]

        <div data-role="page" data-theme="[% sign.swatch %]" id="stream_[% s.sign_stream_id %]">
          <div data-role="header" data-theme="[% sign.swatch %]" data-position="fixed">
            <div style="text-align: center;">
            [%# The header has a list of buttons for all the streams %]
            [%- SET localstreams = streams -%]
            [%- FOREACH stream IN localstreams -%]
              <a href="#stream_[% stream.sign_stream_id %]" data-inline="true" data-role="button">[% stream.name %]</a>
            [% END -%]
            </div>
          </div>
          <div data-role="content">
            <h1>[% s.name %]</h1>
            [%- FOREACH r IN s.records %]
              <a href="#stream[% s.sign_stream_id %]_biblio[% r.biblionumber %]" title="[% r.title %]"><img src="opac-cover.pl?biblionumber=[% r.biblionumber %]" style="border: 1px solid black; min-width: 150px; max-width: 150px; margin: 1em; padding: 1em;"></a>
            [%- END %]
          </div>
          <div data-role="footer" data-theme="[% sign.swatch %]" data-position="fixed">
            <h4>Page Footer</h4>
          </div>
        </div>

        [%- SET records = s.records -%]
        [%- FOREACH r IN s.records -%]
          <div data-role="page" data-theme="[% sign.swatch %]" id="stream[% s.sign_stream_id %]_biblio[% r.biblionumber %]" class="record">
            <div data-role="header" data-theme="[% sign.swatch %]" data-position="fixed">
              <div style="text-align: center;">
              [%- SET localstreams = streams -%]
              [%- FOREACH stream IN localstreams -%]
                <a href="#stream_[% stream.sign_stream_id %]" data-inline="true" data-role="button">[% stream.name %]</a>
              [% END -%]
              </div>
            </div>
            <div data-role="content">
	            <h1>[% r.title %]</h1>
              <div class="coverimg"><img src="opac-cover.pl?biblionumber=[% r.biblionumber %]" style="border: 1px solid black; min-width: 150px; max-width: 150px; margin: 1em; padding: 1em;"></div>
              <div class="recorddescription">
              [%# Copy the MARC object from r.marc into record, to make it easier to write the template in the syspref %]
              [%- SET record = r.marc -%]
              [%- recordtemplate | eval -%]
              </div>
            </div>
            <div data-role="footer" data-theme="[% sign.swatch %]" data-position="fixed" style="text-align: center;">
              [%- SET prev2 = loop.index - 2 -%]
              [%- SET prev1 = loop.index - 1 -%]
              [%- SET this  = loop.index -%]

              [%- SET next1 = loop.index + 1 -%]
              [%- IF next1 == loop.max + 1 -%]
                [%- SET next1 = 0 -%]
              [%- END -%]
              [%- IF next1 == loop.max + 2 -%]
                [%- SET next1 = 1 -%]
              [%- END -%]

              [%- SET next2 = loop.index + 2 -%]
              [%- IF next2 == loop.max + 1 -%]
                [%- SET next2 = 0 -%]
              [%- END -%]
              [%- IF next2 == loop.max + 2 -%]
                [%- SET next2 = 1 -%]
              [%- END -%]

              <a href="#stream[% s.sign_stream_id %]_biblio[% records.${prev2}.biblionumber %]"><img src="opac-cover.pl?biblionumber=[% records.${prev2}.biblionumber %]" style="max-height: 150px; min-height: 150px;"></a>
              <a href="#stream[% s.sign_stream_id %]_biblio[% records.${prev1}.biblionumber %]"><img src="opac-cover.pl?biblionumber=[% records.${prev1}.biblionumber %]" style="max-height: 150px; min-height: 150px;"></a>
              <img src="opac-cover.pl?biblionumber=[% records.${this}.biblionumber %]" style="max-height: 150px; border: 15px solid white; max-height: 150px; min-height: 150px;">
              <a href="#stream[% s.sign_stream_id %]_biblio[% records.${next1}.biblionumber %]"><img src="opac-cover.pl?biblionumber=[% records.${next1}.biblionumber %]" style="max-height: 150px; min-height: 150px;"></a>
              <a href="#stream[% s.sign_stream_id %]_biblio[% records.${next2}.biblionumber %]"><img src="opac-cover.pl?biblionumber=[% records.${next2}.biblionumber %]" style="max-height: 150px; min-height: 150px;"></a>
            </div>
          </div>
        [% END %]

      [% END %]

    [% ELSE %]
      <p>No signs attached to this sign.</p>
    [% END %]
  [% END %]

  [%# Display a list of all signs, as a default. Links use data-ajax="false" so signs will replace the first page, not be AJAXed in. %]
  [%# This page is not meant to be viewed by non-librarians, so it can not be themed. %]
  [% IF ( signs )  %]
    <div data-role="page" id="allsigns">
      <div data-role="header" data-position="fixed">
        <h1>All signs</h1>
      </div>
      <div data-role="content">
        <ul data-role="listview">
        [% FOREACH sign IN signs %]
          <li><a href="?sign=[% sign.sign_id %]" data-ajax="false">[% sign.name %]</a></li>
        [% END %]
        </ul>
      </div>
      <div data-role="footer" data-position="fixed">
        <h4>Page Footer</h4>
      </div>
    </div>
  [% END %]

[% END %]

</body>
</html>
